<!DOCTYPE html>
<html lang="es">
<head>
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<style>
    #calendar { max-width: 900px; margin: 20px auto; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; }
    .fc-daygrid-event { cursor: pointer; }
    .fc-theme-standard td, .fc-theme-standard th { border: 1px solid #444; }
    .fc-header-toolbar { flex-wrap: wrap; gap: 5px; }
    #visor-fotos { display:none; margin-top: 20px; background: rgba(0,0,0,0.5); padding: 15px; border-radius: 10px; }
    .galeria { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 15px; }
    .galeria img { width: 100%; height: 100px; object-fit: cover; border-radius: 5px; }
</style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La 12 - Tabla de puntos</title>
    <style>
        :root { --oro: #ffcc00; --fondo: #1a1a1a; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: url('public/images/la12.jpeg') no-repeat center center fixed; 
            background-size: cover;
            color: white; margin: 0; padding: 20px;
        }
        body::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: -1;
        }
        .nav { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; flex-wrap: wrap; }
        button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 5px; background: #333; color: white; transition: 0.3s; }
        button.active { background: var(--oro); color: black; font-weight: bold; }
        
        .seccion { display: none; background: rgba(30, 30, 30, 0.9); padding: 20px; border-radius: 10px; max-width: 800px; margin: 0 auto; box-shadow: 0 4px 20px rgba(0,0,0,0.8); }
        .active-section { display: block; }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; border-bottom: 1px solid #444; text-align: center; }
        th { color: var(--oro); background: rgba(0,0,0,0.3); }

        .controles { text-align: center; margin-bottom: 20px; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; }
        input { padding: 10px; border-radius: 5px; border: 1px solid #555; background: #222; color: white; margin: 5px; }
        
        .historial-item { border-left: 4px solid var(--oro); padding: 12px; margin-bottom: 10px; background: rgba(255,255,255,0.05); border-radius: 0 8px 8px 0; }
        .fecha { font-size: 0.75em; color: var(--oro); font-weight: bold; }
        .cambio-valor { font-weight: bold; }
    </style>
</head>
<body>

    <h1>üèÜ La 12 - Gesti√≥n de Puntos</h1>

    <div class="nav">
        <button onclick="ver('tabla')" id="btn-tabla" class="active">Tabla</button>
        <button onclick="ver('historial')" id="btn-historial">Historial</button>
        <button onclick="ver('reglamento')" id="btn-reglamento">Reglamento</button>
        <button onclick="ver('eventos')" id="btn-eventos">üìÖ Eventos</button>
    </div>
<div id="eventos" class="seccion">
    <div id="calendar"></div>

    <div id="visor-evento" style="display:none; background:rgba(255,255,255,0.1); padding:20px; border-radius:10px;">
        <h2 id="titulo-evento-sel"></h2>
        <p id="fecha-evento-sel"></p>
        <button id="btn-ver-historial-ev" style="background:var(--oro); color:black;">Ver Puntos de este d√≠a</button>
        
        <hr style="border:0.5px solid #444; margin:20px 0;">
        
        <h4>üì∏ Fotos de la juntada</h4>
        <input type="text" id="url-foto" placeholder="Peg√° link de la foto aqu√≠">
        <button onclick="subirFoto()" style="background:#44ff44; color:black;">Subir</button>
        <div id="galeria-fotos" class="galeria"></div>
        
        <div id="admin-ev" style="display:none; margin-top:20px;">
            <button onclick="borrarEventoActual()" style="background:red; color:white;">Eliminar Evento</button>
        </div>
    </div>

    <div id="controles-eventos" style="display:none; border-top:1px solid #444; padding-top:15px; margin-top:15px;">
        <h4>Crear Evento</h4>
        <input type="text" id="nombre-evento" placeholder="Nombre">
        <input type="date" id="fecha-evento">
        <button onclick="crearEvento()" style="background:var(--oro); color:black;">Agendar</button>
    </div>
</div>
    <div class="controles">
        <input type="password" id="password" placeholder="Clave del Dios de la tabla">
        <button onclick="validarYGuardarClave()" style="background: #444;">Acceder</button>
        <p id="status-clave" style="font-size: 0.8em; margin-top: 5px; color: #aaa;">Si no tenes la clave tomatela rray.</p>
    </div>

    <div id="tabla" class="seccion active-section">
        <table>
            <thead><tr><th>Nombre</th><th>Puntos</th><th>Asistencias</th></tr></thead>
            <tbody id="tabla-cuerpo"></tbody>
        </table>
     <div id="controles-admin" style="margin-top:20px; border-top: 1px solid #444; padding-top:15px;">
    <input type="text" id="nuevo-nombre" placeholder="Nombre nuevo" disabled>
    <button id="btn-agregar" onclick="agregarJugador()" style="background: var(--oro); color: black; opacity: 0.5; cursor: not-allowed;" disabled>Agregar nuevo Therian</button>
</div>
    </div>

    <div id="historial" class="seccion">
        <input type="text" id="filtro-historial" placeholder="Filtrar por nombre..." onkeyup="renderHistorial()" style="width: 90%; margin-bottom: 15px;">
        <div id="lista-historial"></div>
    </div>

<div id="reglamento" class="seccion">
    <h3>‚öñÔ∏è Reglamento</h3>
    <div id="lista-reglamento" style="text-align: left; margin-bottom: 20px;">
        </div>
    
    <div id="controles-reglamento" style="border-top: 1px solid #444; padding-top: 15px; display: none;">
        <input type="text" id="nuevo-regla" placeholder="Ej: Faltar al asado: 50 pts" style="width: 70%;">
        <button onclick="agregarRegla()" style="background: var(--oro); color: black;">A√±adir Regla</button>
    </div>
</div>

<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, push, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCLa7nhMTqvOV5QuQdsfmKAGKHvjv4aEfI",
            databaseURL: "https://tabla-la12-default-rtdb.firebaseio.com",
            projectId: "tabla-la12",
            appId: "1:614852547098:web:3298faf37fe28d965df7a3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // "bGExMg==" es "la12" codificado. Nadie lo sabe si mira el c√≥digo.
const CLAVE_OCULTA = "dGhlcmlhbnM=";
        let cacheHistorial = [];

        window.validarYGuardarClave = () => {
            const input = document.getElementById('password').value.trim().toLowerCase();
            const status = document.getElementById('status-clave');
            
            // Convertimos lo que escrib√≠s a Base64 para comparar
            if(btoa(input) === CLAVE_OCULTA) {
                sessionStorage.setItem('acceso_v12', 'ok');
                status.innerText = "‚úÖ Eso mi rrey. Ya pod√©s editar.";
                status.style.color = "#44ff44";
                document.getElementById('password').value = ""; // Limpiamos el input
                document.getElementById('nuevo-nombre').disabled = false;
                document.getElementById('controles-eventos').style.display = "block";
        document.getElementById('controles-reglamento').style.display = "block";
        document.getElementById('btn-agregar').disabled = false;
        document.getElementById('btn-agregar').style.opacity = "1";
        document.getElementById('btn-agregar').style.cursor = "pointer";
            } else {
                alert("¬°Clave incorrecta Papi! jajode!.");
            }
        };

        const obtenerAcceso = () => sessionStorage.getItem('acceso_v12') === 'ok';

        // --- NAVEGACI√ìN ---
        window.ver = (id) => {
            document.querySelectorAll('.seccion').forEach(s => s.classList.remove('active-section'));
            document.querySelectorAll('.nav button').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active-section');
            document.getElementById('btn-' + id).classList.add('active');
        };

        // --- TABLA ---
        onValue(ref(db, 'jugadores'), (snap) => {
            const data = snap.val();
            const tabla = document.getElementById('tabla-cuerpo');
            if (!tabla) return;
            tabla.innerHTML = '';
            const lista = [];
            for (let id in data) lista.push({id, ...data[id]});
            lista.sort((a,b) => b.puntos - a.puntos);
            lista.forEach(j => {
                const fila = document.createElement('tr');
                fila.innerHTML = `
                    <td><b>${j.nombre}</b></td>
                    <td contenteditable="true" onblur="modificar('${j.id}', 'puntos', this.innerText, ${j.puntos}, '${j.nombre}')">${j.puntos}</td>
                    <td contenteditable="true" onblur="modificar('${j.id}', 'asistencias', this.innerText, ${j.asistencias}, '${j.nombre}')">${j.asistencias}</td>`;
                tabla.appendChild(fila);
            });
        });

        // --- HISTORIAL ---
        onValue(ref(db, 'historial'), (snap) => {
            cacheHistorial = snap.val() ? Object.values(snap.val()).reverse() : [];
            renderHistorial();
        });

        window.renderHistorial = () => {
            const filtro = document.getElementById('filtro-historial').value.toLowerCase();
            const div = document.getElementById('lista-historial');
            if (!div) return;
            div.innerHTML = '';
            cacheHistorial.filter(h => h.jugadorNombre.toLowerCase().includes(filtro)).forEach(h => {
                const color = h.diff > 0 ? "#ff4444" : "#44ff44";
                div.innerHTML += `
                    <div class="historial-item">
                        <div class="fecha">${h.fecha}</div>
                        <b>${h.jugadorNombre}</b>: <span style="color:${color}">${h.diff > 0 ? '+'+h.diff : h.diff} ${h.campo}</span> 
                        <span style="font-size:0.8em; color:#aaa;">(Antes: ${h.antes} - Ahora: ${h.ahora})</span>
                        <div style="font-style:italic; margin-top:5px;">"${h.comentario}"</div>
                    </div>`;
            });
        };

        // --- L√ìGICA DE EDICI√ìN ---
        window.modificar = async (id, campo, nuevoValor, viejoValor, nombreReal) => {
            if (!obtenerAcceso()) {
                alert("Pon√© la clave arriba primero, rray.");
                location.reload(); return;
            }
            const num = parseInt(nuevoValor);
            if (isNaN(num) || num === viejoValor) return;

            const comentario = prompt(`Motivo para ${nombreReal}:`);
            if (!comentario) { location.reload(); return; }

            await update(ref(db, `jugadores/${id}`), { [campo]: num });
            const nuevoHRef = push(ref(db, 'historial'));
            await set(nuevoHRef, {
                jugadorNombre: nombreReal,
                campo: campo,
                antes: viejoValor,
                ahora: num,
                diff: num - viejoValor,
                comentario: comentario,
                fecha: new Date().toLocaleString('es-AR')
            });
        };

window.agregarJugador = async () => {
    // Si alg√∫n vivo intenta llamar a la funci√≥n por consola, esto lo frena
    if (!obtenerAcceso()) { 
        alert("¬°No ten√©s permiso, rray!"); 
        return; 
    }
    
    const nombre = document.getElementById('nuevo-nombre').value;
    if (!nombre) return;
    const id = nombre.toLowerCase().trim().replace(/\s/g, '_');
    await set(ref(db, `jugadores/${id}`), { nombre, puntos: 0, asistencias: 0 });
    document.getElementById('nuevo-nombre').value = '';
};
    // Si ya estaba logueado al recargar, habilitar botones
if (obtenerAcceso()) {
    document.getElementById('nuevo-nombre').disabled = false;
    document.getElementById('btn-agregar').disabled = false;
    document.getElementById('btn-agregar').style.opacity = "1";
    document.getElementById('btn-agregar').style.cursor = "pointer";
}
    // --- L√ìGICA DEL REGLAMENTO ---

// Escuchar cambios en el reglamento
onValue(ref(db, 'reglamento'), (snap) => {
    const data = snap.val();
    const div = document.getElementById('lista-reglamento');
    div.innerHTML = '';
    
    for (let id in data) {
        const item = document.createElement('div');
        item.style.marginBottom = "10px";
        item.style.display = "flex";
        item.style.justifyContent = "space-between";
        
        // El texto es editable si ten√©s la clave
        item.innerHTML = `
            <span ${obtenerAcceso() ? 'contenteditable="true"' : ''} 
                  onblur="editarRegla('${id}', this.innerText)" 
                  style="flex-grow: 1; padding: 5px;">
                ‚Ä¢ ${data[id]}
            </span>
            ${obtenerAcceso() ? `<button onclick="borrarRegla('${id}')" style="background:none; color:red; border:none; padding:0 10px; cursor:pointer;">‚úï</button>` : ''}
        `;
        div.appendChild(item);
    }
});

window.agregarRegla = async () => {
    const texto = document.getElementById('nuevo-regla').value;
    if (!texto || !obtenerAcceso()) return;
    await push(ref(db, 'reglamento'), texto);
    document.getElementById('nuevo-regla').value = '';
};

window.editarRegla = async (id, nuevoTexto) => {
    if (!obtenerAcceso()) return;
    // Quitamos el "‚Ä¢ " del inicio si el usuario lo dej√≥
    const limpio = nuevoTexto.replace('‚Ä¢ ', '').trim();
    if (limpio) await set(ref(db, `reglamento/${id}`), limpio);
};

window.borrarRegla = async (id) => {
    if (obtenerAcceso() && confirm("¬øBorrar esta regla?")) {
        await set(ref(db, `reglamento/${id}`), null);
    }
};
    // --- L√ìGICA DE EVENTOS ---

let calendar;
let eventoSeleccionadoId = null;

// Inicializar Calendario
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'es',
        headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth' },
        events: [],
        eventClick: (info) => abrirEvento(info.event)
    });
    calendar.render();
});

// Cargar Eventos desde Firebase
onValue(ref(db, 'eventos'), (snap) => {
    const data = snap.val();
    const evs = [];
    for(let id in data) {
        evs.push({ id: id, title: data[id].nombre, start: data[id].fecha, allDay: true });
    }
    calendar.removeAllEvents();
    calendar.addEventSource(evs);
});

// Abrir detalle del evento
window.abrirEvento = (ev) => {
    eventoSeleccionadoId = ev.id;
    document.getElementById('visor-evento').style.display = "block";
    document.getElementById('titulo-evento-sel').innerText = ev.title;
    const fCorta = new Date(ev.start + "T00:00:00").toLocaleDateString('es-AR');
    document.getElementById('fecha-evento-sel').innerText = fCorta;
    
    document.getElementById('btn-ver-historial-ev').onclick = () => consultarFecha(fCorta);
    
    if(obtenerAcceso()) document.getElementById('admin-ev').style.display = "block";
    
    cargarFotos(ev.id);
};

// --- L√ìGICA DE FOTOS (Cualquiera puede subir) ---
window.subirFoto = async () => {
    const url = document.getElementById('url-foto').value;
    if(!url || !eventoSeleccionadoId) return;
    await push(ref(db, `fotos/${eventoSeleccionadoId}`), url);
    document.getElementById('url-foto').value = '';
};

function cargarFotos(evId) {
    onValue(ref(db, `fotos/${evId}`), (snap) => {
        const div = document.getElementById('galeria-fotos');
        div.innerHTML = '';
        const data = snap.val();
        for(let id in data) {
            div.innerHTML += `<img src="${data[id]}" onerror="this.src='https://via.placeholder.com/100?text=Error+Link'">`;
        }
    });
}

window.crearEvento = async () => {
    const nombre = document.getElementById('nombre-evento').value;
    const fecha = document.getElementById('fecha-evento').value;
    if(!nombre || !fecha || !obtenerAcceso()) return;
    await push(ref(db, 'eventos'), { nombre, fecha });
};

window.borrarEventoActual = async () => {
    if(confirm("¬øBorrar este evento y sus fotos?") && obtenerAcceso()) {
        await set(ref(db, `eventos/${eventoSeleccionadoId}`), null);
        await set(ref(db, `fotos/${eventoSeleccionadoId}`), null);
        document.getElementById('visor-evento').style.display = "none";
    }
};
    </script>
</body>
</html>
